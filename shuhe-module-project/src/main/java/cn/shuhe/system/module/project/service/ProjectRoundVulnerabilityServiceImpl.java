package cn.shuhe.system.module.project.service;

import cn.shuhe.system.module.project.controller.admin.vo.ProjectRoundVulnerabilitySaveReqVO;
import cn.shuhe.system.module.project.dal.dataobject.ProjectRoundDO;
import cn.shuhe.system.module.project.dal.dataobject.ProjectRoundVulnerabilityDO;
import cn.shuhe.system.module.project.dal.mysql.ProjectRoundMapper;
import cn.shuhe.system.module.project.dal.mysql.ProjectRoundVulnerabilityMapper;
import jakarta.annotation.Resource;
import org.springframework.stereotype.Service;
import org.springframework.validation.annotation.Validated;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static cn.shuhe.system.framework.common.exception.util.ServiceExceptionUtil.exception;
import static cn.shuhe.system.module.project.enums.ErrorCodeConstants.*;

/**
 * 轮次漏洞 Service 实现类
 */
@Service
@Validated
public class ProjectRoundVulnerabilityServiceImpl implements ProjectRoundVulnerabilityService {

    @Resource
    private ProjectRoundVulnerabilityMapper vulnerabilityMapper;

    @Resource
    private ProjectRoundMapper roundMapper;

    @Override
    public Long createVulnerability(ProjectRoundVulnerabilitySaveReqVO createReqVO) {
        // 校验轮次是否存在
        ProjectRoundDO round = roundMapper.selectById(createReqVO.getRoundId());
        if (round == null) {
            throw exception(PROJECT_ROUND_NOT_EXISTS);
        }

        // 创建漏洞
        ProjectRoundVulnerabilityDO vulnerability = ProjectRoundVulnerabilityDO.builder()
                .roundId(createReqVO.getRoundId())
                .projectId(round.getProjectId())
                .targetId(createReqVO.getTargetId())
                .location(createReqVO.getLocation())
                .url(createReqVO.getUrl())
                .severity(createReqVO.getSeverity())
                .type(createReqVO.getType())
                .process(createReqVO.getProcess())
                .typeDescription(createReqVO.getTypeDescription())
                .typeAdvice(createReqVO.getTypeAdvice())
                .build();

        vulnerabilityMapper.insert(vulnerability);
        return vulnerability.getId();
    }

    @Override
    public void updateVulnerability(ProjectRoundVulnerabilitySaveReqVO updateReqVO) {
        // 校验存在
        validateVulnerabilityExists(updateReqVO.getId());

        // 更新
        ProjectRoundVulnerabilityDO updateObj = new ProjectRoundVulnerabilityDO();
        updateObj.setId(updateReqVO.getId());
        updateObj.setTargetId(updateReqVO.getTargetId());
        updateObj.setLocation(updateReqVO.getLocation());
        updateObj.setUrl(updateReqVO.getUrl());
        updateObj.setSeverity(updateReqVO.getSeverity());
        updateObj.setType(updateReqVO.getType());
        updateObj.setProcess(updateReqVO.getProcess());
        updateObj.setTypeDescription(updateReqVO.getTypeDescription());
        updateObj.setTypeAdvice(updateReqVO.getTypeAdvice());

        vulnerabilityMapper.updateById(updateObj);
    }

    @Override
    public void deleteVulnerability(Long id) {
        // 校验存在
        validateVulnerabilityExists(id);
        // 删除
        vulnerabilityMapper.deleteById(id);
    }

    private void validateVulnerabilityExists(Long id) {
        if (vulnerabilityMapper.selectById(id) == null) {
            throw exception(PROJECT_VULNERABILITY_NOT_EXISTS);
        }
    }

    @Override
    public ProjectRoundVulnerabilityDO getVulnerability(Long id) {
        return vulnerabilityMapper.selectById(id);
    }

    @Override
    public List<ProjectRoundVulnerabilityDO> getVulnerabilityListByRoundId(Long roundId) {
        return vulnerabilityMapper.selectListByRoundId(roundId);
    }

    @Override
    public List<ProjectRoundVulnerabilityDO> getVulnerabilityListByTargetId(Long targetId) {
        return vulnerabilityMapper.selectListByTargetId(targetId);
    }

    @Override
    public Map<String, Long> getVulnerabilityStatsByRoundId(Long roundId) {
        Map<String, Long> stats = new HashMap<>();
        stats.put("total", vulnerabilityMapper.selectCountByRoundId(roundId));
        stats.put("high", vulnerabilityMapper.selectCountByRoundIdAndSeverity(roundId, "high"));
        stats.put("medium", vulnerabilityMapper.selectCountByRoundIdAndSeverity(roundId, "medium"));
        stats.put("low", vulnerabilityMapper.selectCountByRoundIdAndSeverity(roundId, "low"));
        return stats;
    }

    @Override
    public void updateRetestInfo(Long id, String retestStatus, String retestReport, LocalDate retestDate) {
        // 校验存在
        validateVulnerabilityExists(id);

        // 更新复测信息
        ProjectRoundVulnerabilityDO updateObj = new ProjectRoundVulnerabilityDO();
        updateObj.setId(id);
        updateObj.setRetestStatus(retestStatus);
        updateObj.setRetestReport(retestReport);
        updateObj.setRetestDate(retestDate);
        updateObj.setRetestTime(LocalDateTime.now());

        vulnerabilityMapper.updateById(updateObj);
    }

}
